<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>第5步-环节</title>
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <h1>魏小玉 · 主持稿生成器</h1>
      <div class="sub">一步一步填写 → 手动选环节 → 生成可直接照读的主持稿</div>
    </div>
    <div class="stepper" aria-label="步骤">
      <span class="step" data-step>1. 基础信息</span>
<span class="step" data-step>2. 主题</span>
<span class="step" data-step>3. 风格</span>
<span class="step" data-step>4. 人物</span>
<span class="step" data-step>5. 环节</span>
<span class="step" data-step>6. 生成</span>
    </div>
  </div>
</header>

<main>
  
<section class="card">
  <h2>第 5 步：选择环节（完全手动）</h2>
  <p class="hint">左边是“全部环节库”，你勾选需要的；右边是“已选环节”，可以上下调整顺序。</p>

  <div class="twoCol">
    <div>
      <label for="search">搜索环节</label>
      <input id="search" placeholder="输入关键词，例如：敬茶 / 祝酒 / 发言" />
      <div class="actions" style="margin-top:10px">
        <button class="ghost" id="selectAll">全选（当前筛选结果）</button>
        <button class="ghost" id="selectNone">全不选</button>
      </div>
      <hr class="sep" />
      <div id="allSegments" class="list"></div>
    </div>

    <div>
      <div class="notice">
        <b>已选环节：</b><span id="selectedCount">0</span> 个
        <div class="hint">提示：顺序就是生成稿件的顺序。</div>
      </div>
      <hr class="sep" />
      <div id="selectedSegments" class="list"></div>
    </div>
  </div>

  <div class="actions">
    <button class="ghost" id="back">上一步</button>
    <button class="primary" id="next">下一步：生成稿件</button>
  </div>
</section>

</main>

<script src="../assets/app.js"></script>
<script>
  setStepper(4);
  
(async () => {
  const st = getState();
  if (!st.themeId) { alert("请先选择主题"); go("step2-theme.html"); return; }
  
  // 应用当前主题样式
  setPageTheme(st.themeId);
  showThemeIcon(st.themeId);
  
  const themeData = await loadThemeSegments(st.themeId);

  const allBox = qs("#allSegments");
  const selBox = qs("#selectedSegments");
  const search = qs("#search");
  
  // 设置搜索框默认值
  search.value = "敬茶";

  // state.selectedSegments is ordered array of ids
  let selected = Array.isArray(st.selectedSegments) ? [...st.selectedSegments] : [];

  const segs = themeData.segments; // {id,title,group,explain,hostLines...}
  const groupOrder = themeData.groupOrder || [];
  const groupRank = new Map(groupOrder.map((g,i)=>[g,i]));
  const sortedAll = [...segs].sort((a,b)=>{
    const ra = groupRank.has(a.group) ? groupRank.get(a.group) : 999;
    const rb = groupRank.has(b.group) ? groupRank.get(b.group) : 999;
    if (ra !== rb) return ra - rb;
    return a.title.localeCompare(b.title, "zh");
  });

  function isChecked(id){ return selected.includes(id); }

  function renderSelected() {
    qs("#selectedCount").textContent = String(selected.length);
    selBox.innerHTML = "";
    if (!selected.length) {
      selBox.innerHTML = `<div class="hint">还没有选择任何环节。右边会按顺序生成稿件。</div>`;
      return;
    }
    selected.forEach((id, idx) => {
      const s = segs.find(x=>x.id===id);
      if (!s) return;
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="item-top">
          <div>
            <div class="item-title">${escapeHtml(s.title)}</div>
            <div class="hint"><span class="badge">${escapeHtml(s.group)}</span></div>
          </div>
          <div class="small-actions">
            <button class="ghost" data-act="up" ${idx===0?'disabled':''}>上移</button>
            <button class="ghost" data-act="down" ${idx===selected.length-1?'disabled':''}>下移</button>
            <button class="danger" data-act="remove">移除</button>
          </div>
        </div>
      `;
      div.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          if (act === "remove") {
            selected = selected.filter(x=>x!==id);
            renderAll();
            renderSelected();
          } else if (act === "up" && idx>0) {
            const tmp = selected[idx-1]; selected[idx-1] = selected[idx]; selected[idx] = tmp;
            renderSelected();
          } else if (act === "down" && idx<selected.length-1) {
            const tmp = selected[idx+1]; selected[idx+1] = selected[idx]; selected[idx] = tmp;
            renderSelected();
          }
        });
      });
      selBox.appendChild(div);
    });
  }

  function renderAll() {
    const q = (search.value || "").trim();
    const filtered = !q ? sortedAll : sortedAll.filter(s =>
      (s.title + " " + s.group).includes(q)
    );

    // group headers
    const byGroup = new Map();
    filtered.forEach(s => {
      if (!byGroup.has(s.group)) byGroup.set(s.group, []);
      byGroup.get(s.group).push(s);
    });

    const groups = Array.from(byGroup.keys()).sort((a,b)=>{
      const ra = groupRank.has(a) ? groupRank.get(a) : 999;
      const rb = groupRank.has(b) ? groupRank.get(b) : 999;
      if (ra !== rb) return ra - rb;
      return a.localeCompare(b, "zh");
    });

    allBox.innerHTML = "";
    groups.forEach(g => {
      const head = document.createElement("div");
      head.className = "notice";
      head.style.margin = "0 0 8px 0";
      head.innerHTML = `<b>${escapeHtml(g)}</b>（${byGroup.get(g).length}）`;
      allBox.appendChild(head);

      byGroup.get(g).forEach(s => {
        const div = document.createElement("div");
        div.className = "item";
        const checked = isChecked(s.id) ? "checked" : "";
        div.innerHTML = `
          <div class="item-top">
            <div style="display:flex; gap:10px; align-items:flex-start">
              <input type="checkbox" data-id="${escapeHtml(s.id)}" ${checked} style="transform:scale(1.25); margin-top:2px" />
              <div>
                <div class="item-title">${escapeHtml(s.title)}</div>
                <div class="hint">${escapeHtml(chooseText(s.explain, st.styleId || "warm").slice(0, 42))}…</div>
              </div>
            </div>
            <span class="badge">${escapeHtml(s.group)}</span>
          </div>
        `;
        const cb = div.querySelector("input[type=checkbox]");
        cb.addEventListener("change", () => {
          if (cb.checked) {
            if (!selected.includes(s.id)) selected.push(s.id);
          } else {
            selected = selected.filter(x => x !== s.id);
          }
          renderSelected();
        });
        allBox.appendChild(div);
      });
    });
  }

  search.addEventListener("input", renderAll);

  qs("#selectAll").addEventListener("click", () => {
    const q = (search.value || "").trim();
    const filtered = !q ? sortedAll : sortedAll.filter(s => (s.title + " " + s.group).includes(q));
    filtered.forEach(s => { if (!selected.includes(s.id)) selected.push(s.id); });
    renderAll(); renderSelected();
  });

  qs("#selectNone").addEventListener("click", () => {
    if (!confirm("确定全部取消勾选吗？")) return;
    selected = [];
    renderAll(); renderSelected();
  });

  qs("#back").addEventListener("click", ()=> go("step4-people.html"));
  qs("#next").addEventListener("click", ()=> {
    if (!selected.length) { alert("请至少选择一个环节"); return; }
    setState({ selectedSegments: selected });
    go("step6-result.html");
  });

  renderAll();
  renderSelected();
})();

</script>
</body>
</html>
